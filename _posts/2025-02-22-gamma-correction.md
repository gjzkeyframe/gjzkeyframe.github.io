---
title: 伽马校正及相关技术延伸：这次把伽马校正讲清楚
description: 介绍伽马校正的起源及原理知识。
author: Keyframe
date: 2025-02-22 08:55:08 +0800
categories: [音视频基础知识]
tags: [音视频基础知识, 音视频, 图像, 伽马校正]
pin: false
math: true
mermaid: true
---

> 本文转自微信公众号 `关键帧Keyframe`，推荐您关注来获取**音视频**、**AI** 领域的最新技术和产品信息：
>
>![微信公众号](assets/img/keyframe-mp.jpg)
_微信扫码关注我们_
{: .prompt-tip }

## 1、伽马校正

在视频的图像处理中，我们可能在很多地方都听说过`伽马校正`这个概念，它到底是干什么的呢？这里我们来探讨一下这个概念。


如果大家接触过更早的电视机或电脑显示器，应该知道一种叫做阴极射线管（CRT）的显示设备，这种设备的显示原理是使用一个电压轰击它的屏幕来发光以展示图像。人们在使用 CRT 时发现它有一个问题：调节电压为原来的 n 倍，对应的屏幕发光亮度并没有提高 n 倍，而是一个类似幂律曲线的关系，其公式粗略表示为：

$$ V_{out} = V_{in}^γ $$

**典型的 CRT 显示器产生的亮度约为输入电压的 2.2 次幂**，即在上述公式中 γ 为 2.2，这个称为`显示伽马（Display Gamma）`。

由于显示伽马问题的存在，**为了使最终显示出来的图像亮度与捕捉到的真实场景的亮度是成线性比例关系**，就需要在将图像输入到显示器之前对信号进行一个修正，这个修正过程就叫做`伽马校正（Gamma Correction）`，而这里的修正过程增加的伽马则叫做`编码伽马（Encoding Gamma）`。增加编码伽马通常是**在图像采集设备的电路中完成的**，比如对于 TV 摄像机，需要将感知到的亮度 Y 通过以典型的数值 1/γ = 0.45 做逆伽马重新映射：

$$ Y' = Y^{\frac{1}{γ}} $$

![CRT 伽马和伽马校正](assets/resource/av-basic-knowledge/av-image-presentation-62.png)
_CRT 伽马和伽马校正_


所以，一个完整的图像获取和显示系统，需要至少两个伽马值：1）编码伽马，体现了设备获取到的场景亮度值和编码像素值之间的关系；2）显示伽马，体现了编码像素值和显示器亮度之间的关系。

而编码伽马和显示伽马的乘积就是整个图像系统的`端到端伽马（End-to-End Gamma）`。如果这个乘积为 1，那么显示出来的图像亮度与捕捉到的真实场景的亮度就是成线性比例的。


不过，在计算机视觉的一些图像处理场景，需要图像的亮度信息在线性空间中才能进行，这时候则需要撤销伽马校正后再进行处理。在处理完成后，将图像输入显示器之前再重新做伽马校正。



上面提到了显示伽马是 CRT 显示器带来的问题，如今我们已经基本告别 CRT 显示器普遍使用 LCD 显示器了，那显示伽马的问题是不是就没有了呢？事实上，**LCD 显示器本身确实没有 CRT 显示器的伽马效应，但是为了兼容性，LCD 以及其他非 CRT 显示设备都模拟了这个伽马效应以实现先前兼容，甚至可以支持动态调节伽马参数。**

我们看一个例子，当你的显示器已校准为 2.2 的标准伽马时，下图展示了在编码伽马确定时，不同显示伽马对系统端到端伽马的影响以及对最终图像展示效果的影响：

![不同显示伽马下的图像](assets/resource/av-basic-knowledge/av-image-presentation-61.png)
_不同显示伽马下的图像_





## 2、伽马校正的额外收益：降噪

上面的伽马校正的所做非线性转换过程除了解决显示伽马的问题外，还带来了一个`额外收益`：**传输期间增加的噪声（模拟信号时代），在噪声比较明显的较暗信号区域（在接收器做了伽马校正后）会被减少。因为我们的视觉系统对相对亮度差别是敏感的，经过伽马校正后的非线性梯度明显对人眼感知来说更均匀。**如下图所示，


![线性和非线性的亮度效果](assets/resource/av-basic-knowledge/av-image-presentation-60.png)
_线性和非线性的亮度效果_




## 3、伽马校正技术的延伸：光电转换函数

视觉系统对相对亮度差别更加敏感，使得我们人眼对亮度的感知是非线性的，通常我们对中等亮度和暗部区域的敏感程度远高于高亮度区域，**这个发现成为了后续伽马校正技术延续发展的核心原因**。

怎么解释这句话呢？其实到如今，随着数字信号技术的广泛应用，在传输系统中我们不再有模拟噪声了，而且上面说过 LCD 显示器也没有显示伽马的问题了，整个图像采集、编码、传输、解码、显示的流程中，似乎直接都用线性信号也没什么问题了。但是，在对采集的信号进行编码压缩时仍然是需要量化的，而又因为人眼对亮度感知是非线性的特点，我们可以**用更多的码率来编码人眼敏感的中等亮度或暗部细节，从而使得编码在讨好人眼上有更好的 ROI。这样一来，我们在采集电路中采集到光信号向电信号转换时，通常会将其转换为非线性信号，以利于我们做编码**，因此在传感数据上做伽马校正仍然是有用的。只是我们的伽马曲线参数要做调整了，曲线参数的**目标不再是面向之前的 CRT 显示伽马，而是面向人眼的特性**。这就有了后续的`光电转换函数（Optical-Electro Transfer Function）`和`电光转换函数（Electro-Optical Transfer Function）`。


其中在 HDR 技术发展的过程中，就有 PQ 曲线和 HLG 曲线成为了标准：

- `PQ（Perceptual Quantizer，感知量化）曲线`的设计更接近人眼的特点，亮度表达更准确。基于人眼的对比敏感度函数（Contrast Sensitivity Function，CSF），在 SMPTE ST 2084 标准中规定了 EOTF 曲线。亮度范围可从最暗 0.00005nit 到最亮 10000nit。PQ 曲线最早是由 Dolby 公司开发的，并且在 ST 2084 中进行了标准化。
- `HLG（Hybrid Log Gamma，混合对数伽马）曲线`是另外一个重要的 HDR 转换函数曲线，由 BBC 和 NHK 公司开发。这个曲线与 PQ 曲线不同，HLG 规定的是 OETF 曲线，因为在低亮度区域基本与 Gamma 曲线重合，所以提供了与 SDR 显示设备很好的兼容性，在广播电视系统里有着广泛的应用。HLG 曲线最早在 ARIB STD-B67 中进行了标准化，后面也进入了 ITU-R BT.2100。

![OETF 和 EOTF](assets/resource/av-basic-knowledge/transcode-hdr-to-sdr-5.png)
_OETF 和 EOTF_


![SDR 和 HDR 的非线性编码](assets/resource/av-basic-knowledge/transcode-hdr-to-sdr-8.jpg)
_SDR 和 HDR 的非线性编码_


这样一来，常见的图像处理系统中光信号和电信号的转换通常有如下流程：

![图像处理系统中的光电转换](assets/resource/av-basic-knowledge/gamma-1.png)
_图像处理系统中的光电转换_


参考：

- [微博 HDR 视频的落地实践](https://mp.weixin.qq.com/s?__biz=MzU1NTEzOTM5Mw==&mid=2247520083&idx=1&sn=bc1768947ce8671a43a912b2a6917c3b&scene=21#wechat_redirect)



## 4、线性颜色空间仍有使用场景

上面我们介绍 CRT 显示器的显示伽马时，反复提到了 Gamma 系数 2.2，这个 2.2 是大多数 CRT 显示器的平均 Gamma 值。基于这个原因，1996 年，惠普与微软选择 Gamma 校准系数为 2.2 的颜色空间作为一种标准推出作为生成在因特网上浏览的图像的通用颜色空间，这就是 `sRGB（Standard RGB）颜色空间`，这是一个非线性的颜色空间。这个标准得到了 W3C、Exif、英特尔、Pantone、Corel 以及其它许多业界厂商的支持，在 GIMP 这样的开放源代码软件也支持这种标准，另外一些专有的或者像 SVG 这样的开放图形文件格式中也有应用。这样一来，遵循 sRGB 标准的图像处理都在这个非线性颜色空间中处理即可。

但是，如我们上面提到的，在计算机视觉的一些图像处理场景，还是需要图像的亮度信息在线性颜色空间中才能进行处理，这时候则需要撤销伽马校正后再进行处理。在处理完成后，将图像输入显示器之前再重新做伽马校正。

所以，**只要我们有在线性空间对采集后的图像做处理的需求，线性空间就仍然有使用场景。**

不过需要注意的是，随着 HDR 技术发展带来了新的光电转换函数，在做图像处理时就需要匹配正确的转换函数来做非线性信号和线性信号之间的转换，如果匹配出错了就可能造成颜色异常。

















